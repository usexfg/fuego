name: XFG Wallet - Android Build

on:
  push:
    branches: [ master, dynamigo-release-v10, dynamigo ]
    paths:
      - 'src/PaymentGate/**'
      - 'src/PaymentGateService/**'
      - 'src/Wallet/**'
      - 'src/WalletLegacy/**'
      - 'src/SimpleWallet/**'
      - 'src/JsonRpcServer/**'
      - 'src/Rpc/**'
      - 'src/Serialization/**'
      - 'src/Transfers/**'
      - 'src/NodeRpcProxy/**'
      - 'src/InProcessNode/**'
      - 'src/Logging/**'
      - 'src/Http/**'
      - 'src/Common/**'
      - 'src/Crypto/**'
      - 'src/CryptoNoteCore/**'
      - 'src/CryptoNoteProtocol/**'
      - 'src/P2p/**'
      - 'src/System/**'
      - 'CMakeLists.txt'
      - 'src/CMakeLists.txt'
      - '.github/workflows/wallet-android.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'src/PaymentGate/**'
      - 'src/PaymentGateService/**'
      - 'src/Wallet/**'
      - 'src/WalletLegacy/**'
      - 'src/SimpleWallet/**'
      - 'src/JsonRpcServer/**'
      - 'src/Rpc/**'
      - 'src/Serialization/**'
      - 'src/Transfers/**'
      - 'src/NodeRpcProxy/**'
      - 'src/InProcessNode/**'
      - 'src/Logging/**'
      - 'src/Http/**'
      - 'src/Common/**'
      - 'src/Crypto/**'
      - 'src/CryptoNoteCore/**'
      - 'src/CryptoNoteProtocol/**'
      - 'src/P2p/**'
      - 'src/System/**'
      - 'CMakeLists.txt'
      - 'src/CMakeLists.txt'
      - '.github/workflows/wallet-android.yml'
  workflow_dispatch:

jobs:
  build-android-wallet:
    name: Android Wallet Build
    runs-on: ubuntu-22.04
    
    env:
      CMAKE_BUILD_TYPE: Release
      ANDROID_NDK_VERSION: 25.2.9519653
      ANDROID_API_LEVEL: 21
      ANDROID_ABI: arm64-v8a

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}

      - name: Cache Android dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-android-${{ hashFiles('**/CMakeLists.txt') }}-${{ env.CMAKE_BUILD_TYPE }}

      - name: Install Android dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Configure CMake for Android
        run: |
          mkdir -p build-android
          cd build-android
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK_ROOT \
            -DCMAKE_ANDROID_ARCH_ABI=$ANDROID_ABI \
            -DCMAKE_ANDROID_API_LEVEL=$ANDROID_API_LEVEL \
            -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE \
            -DANDROID_STL=c++_shared \
            -DANDROID_TOOLCHAIN=clang \
            -DCMAKE_ANDROID_STL_TYPE=c++_shared \
            -DBUILD_TESTS=OFF \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build Android Wallet
        run: |
          cd build-android
          make -j$(nproc) PaymentGateService SimpleWallet

      - name: Verify Android binaries
        run: |
          cd build-android
          file src/walletd
          file src/fuego-wallet-cli
          # Check that binaries are Android ARM64
          readelf -h src/walletd | grep "Machine:"
          readelf -h src/fuego-wallet-cli | grep "Machine:"

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xfg-wallet-android-${{ github.sha }}
          path: |
            build-android/src/walletd
            build-android/src/fuego-wallet-cli
          retention-days: 30

      - name: Create Android release package
        run: |
          mkdir -p release-android
          cp build-android/src/walletd release-android/
          cp build-android/src/fuego-wallet-cli release-android/
          
          # Create a simple README for Android
          cat > release-android/README.md << 'EOF'
          # XFG Wallet for Android
          
          This package contains the XFG wallet binaries built for Android ARM64.
          
          ## Binaries
          - `walletd`: Wallet daemon service (for Android wallet apps)
          - `fuego-wallet-cli`: Command line wallet interface
          
          ## Usage
          These binaries are designed to be integrated into Android wallet applications.
          The `walletd` service provides the core wallet functionality via JSON-RPC API.
          
          ## Architecture
          - Target: Android ARM64 (aarch64)
          - API Level: 21+
          - Build: Release
          - Commit: ${{ github.sha }}
          EOF
          
          # Create archive
          tar -czf xfg-wallet-android-${{ github.sha }}.tar.gz -C release-android .

      - name: Upload Android release package
        uses: actions/upload-artifact@v4
        with:
          name: xfg-wallet-android-release-${{ github.sha }}
          path: xfg-wallet-android-${{ github.sha }}.tar.gz
          retention-days: 90

  test-android-wallet:
    name: Test Android Wallet
    runs-on: ubuntu-22.04
    needs: build-android-wallet
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: xfg-wallet-android-${{ github.sha }}
          path: android-binaries/

      - name: Test Android binary compatibility
        run: |
          # Test that binaries are valid Android ARM64
          file android-binaries/walletd
          file android-binaries/fuego-wallet-cli
          
          # Verify they're not corrupted
          ls -la android-binaries/
          
          # Basic binary analysis
          readelf -h android-binaries/walletd
          readelf -h android-binaries/fuego-wallet-cli
          
          echo "Android wallet binaries verified successfully!"

      - name: Test walletd help
        run: |
          # Test that walletd can show help (basic functionality test)
          timeout 10s android-binaries/walletd --help || echo "Help command completed or timed out as expected"
